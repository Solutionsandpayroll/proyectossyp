<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Ahorros – S&P Gestión</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#102a47",
                        "accent": "#e51148",
                        "background-light": "#f6f7f8",
                        "background-dark": "#13191f",
                    },
                    fontFamily: { "display": ["Outfit", "sans-serif"] },
                    borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style>
        html {
            font-size: 110%;
        }

        body {
            font-family: 'Outfit', sans-serif;
        }

        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
            /* Prevent icon bleed into adjacent text */
            display: inline-flex;
            align-items: center;
            justify-content: center;
            vertical-align: middle;
            line-height: 1;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 7px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 11px;
        }

        /* ── Consolidado ── */
        @keyframes pulseGlow {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(229, 17, 72, 0.3);
            }

            50% {
                box-shadow: 0 0 0 13px rgba(229, 17, 72, 0);
            }
        }

        @keyframes shimmer {
            0% {
                background-position: -440px 0;
            }

            100% {
                background-position: 440px 0;
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.85);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes float1 {

            0%,
            100% {
                transform: translate(0, 0) scale(1);
                opacity: .15;
            }

            33% {
                transform: translate(9px, -13px) scale(1.2);
                opacity: .3;
            }

            66% {
                transform: translate(-7px, 7px) scale(0.9);
                opacity: .1;
            }
        }

        @keyframes float2 {

            0%,
            100% {
                transform: translate(0, 0) scale(1);
                opacity: .1;
            }

            50% {
                transform: translate(-11px, 9px) scale(1.3);
                opacity: .25;
            }
        }

        .consolidado-section {
            opacity: 0;
        }

        .consolidado-section.visible {
            opacity: 1;
        }

        .stat-card {
            animation: scaleIn 0.5s ease forwards;
            opacity: 0;
        }

        .arc-ejecutado {
            stroke-dasharray: var(--dash-total);
            stroke-dashoffset: var(--dash-total);
            transition: stroke-dashoffset 1.8s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .arc-proyectado {
            stroke-dasharray: var(--dash-total);
            stroke-dashoffset: var(--dash-total);
            transition: stroke-dashoffset 2.2s cubic-bezier(0.16, 1, 0.3, 1) 0.2s;
        }

        .progress-fill {
            width: 0%;
            transition: width 2s cubic-bezier(0.16, 1, 0.3, 1) 0.4s;
        }

        .progress-animated .progress-fill {
            width: var(--target-width);
        }

        .shimmer-bg {
            background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.08) 50%, transparent 100%);
            background-size: 440px 100%;
            animation: shimmer 2.5s infinite;
        }

        .counter {
            display: inline-block;
            transition: all 0.1s;
        }

        .dot-float-1 {
            animation: float1 6s ease-in-out infinite;
        }

        .dot-float-2 {
            animation: float2 8s ease-in-out infinite 1s;
        }

        .dot-float-3 {
            animation: float1 7s ease-in-out infinite 2s;
        }

        /* ═══════════════════════════════════════════════
           ACTIVIDADES – Refined visual system
        ═══════════════════════════════════════════════ */
        @keyframes actFadeUp {
            from {
                opacity: 0;
                transform: translateY(18px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes labelPop {
            from {
                opacity: 0;
                transform: scale(.7);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes chipPulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(229, 17, 72, .3);
            }

            50% {
                box-shadow: 0 0 0 6px rgba(229, 17, 72, 0);
            }
        }

        @keyframes glowLine {

            0%,
            100% {
                opacity: .25;
            }

            50% {
                opacity: .7;
            }
        }

        @keyframes scanline {
            0% {
                top: -4px;
            }

            100% {
                top: 100%;
            }
        }

        .act-panel {
            opacity: 0;
            animation: actFadeUp .6s cubic-bezier(.16, 1, .3, 1) forwards;
        }

        /* ── Control chips – compact & unified ── */
        .ctrl-chip {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            padding: 3px 11px;
            border-radius: 9999px;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            transition: all .15s ease;
            border: 2px solid transparent;
            letter-spacing: .03em;
            text-transform: uppercase;
            user-select: none;
            line-height: 1.6;
        }

        .ctrl-chip .material-symbols-outlined {
            font-size: 13px !important;
        }

        .ctrl-chip.inactive {
            background: #f1f5f9;
            color: #94a3b8;
            border-color: #e2e8f0;
        }

        .ctrl-chip.inactive:hover {
            background: #e2e8f0;
            color: #475569;
        }

        .ctrl-chip.active-pri {
            background: #102a47;
            color: #fff;
            border-color: #102a47;
        }

        .ctrl-chip.active-acc {
            background: #e51148;
            color: #fff;
            border-color: #e51148;
            animation: chipPulse 2.5s ease infinite;
        }

        .ctrl-chip.active-mid {
            background: #0ea5e9;
            color: #fff;
            border-color: #0ea5e9;
        }

        .ctrl-chip.active-amb {
            background: #f59e0b;
            color: #fff;
            border-color: #f59e0b;
        }

        /* ── Form controls – compact unified ── */
        .act-select {
            appearance: none;
            background: #f8fafc url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' viewBox='0 0 10 6'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%2394a3b8' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E") no-repeat right 9px center;
            padding: 4px 26px 4px 11px;
            border: 2px solid #e2e8f0;
            border-radius: 7px;
            font-family: 'Outfit', sans-serif;
            font-size: 11px;
            font-weight: 600;
            color: #334155;
            cursor: pointer;
            outline: none;
            transition: border-color .15s;
            height: 31px;
        }

        .act-select:focus {
            border-color: #102a47;
        }

        .act-date {
            padding: 4px 11px;
            border: 2px solid #e2e8f0;
            border-radius: 7px;
            font-family: 'Outfit', sans-serif;
            font-size: 11px;
            font-weight: 600;
            color: #334155;
            outline: none;
            background: #f8fafc;
            transition: border-color .15s;
            width: 136px;
            height: 31px;
        }

        .act-date:focus {
            border-color: #102a47;
        }

        .act-search {
            padding: 4px 11px 10px 84px;
            border: 2px solid #e2e8f0;
            border-radius: 7px;
            font-family: 'Outfit', sans-serif;
            font-size: 9px;
            font-weight: 600;
            color: #334155;
            outline: none;
            background: #f8fafc;
            width:200px;
            transition: border-color .15s, width .2s;
            height: 31px;
        }

        .act-search:focus {
            border-color: #102a47;
            width: 220px;
        }


        /* ── Filter group label ── */
        .filter-label {
            font-size: 11px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: .08em;
            color: #94a3b8;
            white-space: nowrap;
        }

        /* ── Filter rows ── */
        .filter-row {
            display: flex;
            align-items: center;
            gap: 11px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-divider {
            width: 2px;
            height: 19px;
            background: #e2e8f0;
            flex-shrink: 0;
        }

        /* ── Chart bars ── */
        .chart-row {
            display: flex;
            align-items: center;
            gap: 0;
            min-height: 35px;
            position: relative;
        }

        .chart-label {
            width: 185px;
            min-width: 185px;
            font-size: 11px;
            font-weight: 700;
            color: #334155;
            text-align: right;
            padding-right: 11px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.2;
        }

        .chart-track {
            flex: 1;
            height: 28px;
            background: #f1f5f9;
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }

        .chart-bar {
            height: 100%;
            border-radius: 6px;
            position: relative;
            overflow: hidden;
            transition: width 1.1s cubic-bezier(.16, 1, .3, 1), opacity .3s;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 7px;
            min-width: 4px;
        }

        .chart-bar-shimmer {
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, .15) 50%, transparent 100%);
            background-size: 440px 100%;
            animation: shimmer 2.5s infinite;
        }

        .chart-val {
            font-size: 11px;
            font-weight: 900;
            color: #fff;
            font-family: monospace;
            position: relative;
            z-index: 1;
            white-space: nowrap;
            text-shadow: 0 2px 3px rgba(0, 0, 0, .35);
            opacity: 0;
            animation: labelPop .4s ease forwards;
        }

        .chart-meta {
            width: 110px;
            min-width: 110px;
            padding-left: 11px;
            font-size: 11px;
            color: #94a3b8;
            font-weight: 600;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .chart-grid {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: rgba(0, 0, 0, .05);
            pointer-events: none;
        }

        .chart-track::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, .5), transparent);
            top: -4px;
            opacity: 0;
            pointer-events: none;
            transition: opacity .2s;
        }

        .chart-row:hover .chart-track::after {
            opacity: 1;
            animation: scanline 1.2s linear infinite;
        }

        .chart-row:hover .chart-label {
            color: #102a47;
        }

        .chart-row:hover .chart-track {
            background: #e8edf2;
        }

        /* ── Stat pills in header ── */
        .stat-pill {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 11px;
            border-radius: 9999px;
            font-size: 11px;
            font-weight: 800;
            letter-spacing: .03em;
            text-transform: uppercase;
        }

        .stat-pill .material-symbols-outlined {
            font-size: 13px !important;
        }

        .glow-sep {
            height: 2px;
            background: linear-gradient(90deg, transparent, #e51148 30%, #102a47 70%, transparent);
            animation: glowLine 3s ease infinite;
        }

        .active-filter-tag {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            padding: 2px 7px;
            background: rgba(16, 42, 71, .07);
            border: 2px solid rgba(16, 42, 71, .12);
            border-radius: 9999px;
            font-size: 11px;
            font-weight: 700;
            color: #102a47;
        }

        .active-filter-tag button {
            display: inline-flex;
            align-items: center;
            color: #94a3b8;
            cursor: pointer;
            font-size: 15px;
            line-height: 1;
            padding: 0;
            background: none;
            border: none;
        }

        .active-filter-tag button:hover {
            color: #e51148;
        }

        .act-tooltip {
            position: fixed;
            background: #102a47;
            color: #fff;
            border-radius: 11px;
            padding: 11px 15px;
            font-size: 11px;
            font-weight: 700;
            pointer-events: none;
            z-index: 999;
            box-shadow: 0 9px 31px rgba(16, 42, 71, .28);
            opacity: 0;
            transition: opacity .12s;
            min-width: 187px;
            border: 2px solid rgba(255, 255, 255, .07);
        }

        .empty-chart {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 46px 0;
            color: #94a3b8;
            gap: 9px;
        }

        .chart-scroll {
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #e2e8f0 transparent;
            max-height: 638px;
        }

        .chart-scroll::-webkit-scrollbar {
            width: 3px;
        }

        .chart-scroll::-webkit-scrollbar-thumb {
            background: #e2e8f0;
            border-radius: 7332px;
        }
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-slate-100 font-display">
    <div class="flex h-screen overflow-hidden">

        <!-- ── Sidebar ── -->
        <aside class="w-64 bg-primary flex flex-col h-full border-r border-primary/10">
            <div class="px-5 py-4 flex items-center justify-start border-b border-white/10">
                <img src="logo.png" alt="Solutions & Payroll" class="h-14 w-auto object-contain" />
            </div>
            <nav class="flex-1 px-4 space-y-1 mt-4">
                <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-white/70 hover:bg-white/10 hover:text-white transition-colors"
                    href="index.html">
                    <span class="material-symbols-outlined text-xl">dashboard</span>
                    <span class="text-sm font-medium">Inicio</span>
                </a>
                <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-white/70 hover:bg-white/10 hover:text-white transition-colors"
                    href="proyectos.html">
                    <span class="material-symbols-outlined text-xl">sync_alt</span>
                    <span class="text-sm font-medium">Procesos</span>
                </a>
                <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-white/70 hover:bg-white/10 hover:text-white transition-colors"
                    href="tickets.html">
                    <span class="material-symbols-outlined text-xl">confirmation_number</span>
                    <span class="text-sm font-medium">Tickets</span>
                </a>
                <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg bg-white/10 text-white transition-colors"
                    href="ahorros.html">
                    <span class="material-symbols-outlined text-xl">savings</span>
                    <span class="text-sm font-medium">Ahorros</span>
                </a>
            </nav>
            <div class="px-4 py-6 mt-auto border-t border-white/10">
                <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-white/70 hover:bg-white/10 hover:text-white transition-colors"
                    href="#">
                    <span class="material-symbols-outlined text-xl">settings</span>
                    <span class="text-sm font-medium">Configuración</span>
                </a>
            </div>
        </aside>

        <!-- ── Main ── -->
        <main class="flex-1 overflow-y-auto bg-background-light dark:bg-background-dark flex flex-col custom-scrollbar">
            <header
                class="py-5 px-8 bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 flex flex-col md:flex-row md:items-center justify-between gap-4 sticky top-0 z-10 shrink-0">
                <div>
                    <h2 class="text-2xl font-black text-primary dark:text-white tracking-tight">Ahorros</h2>
                    <p class="text-slate-500 dark:text-slate-400 text-xs mt-0.5">Control de ahorros asociados a
                        procesos.</p>
                </div>
                <button id="btn-nuevo-ahorro"
                    class="flex items-center justify-center gap-2 bg-accent hover:bg-accent/90 text-white px-4 py-2 rounded-lg text-sm font-bold transition-all shadow-lg shadow-accent/20">
                    <span class="material-symbols-outlined" style="font-size:22px;">add_circle</span>
                    Registrar Ahorro
                </button>
            </header>

            <div class="p-6 space-y-5 max-w-7xl mx-auto w-full">

                <!-- Buscador -->
                <div class="relative">
                    <span class="material-symbols-outlined absolute left-5 top-1/2 -translate-y-1/2 text-slate-400"
                        style="font-size:22px;">search</span>
                    <input id="search-ahorros"
                        class="w-full pl-16 pr-4 py-2 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg text-sm focus:ring-2 focus:ring-primary/20 focus:outline-none"
                        placeholder="Buscar ahorros por proceso, área o estatus..." type="text" />
                </div>

                <!-- Tabla -->
                <div
                    class="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead
                                class="bg-slate-50 dark:bg-slate-800/50 text-slate-500 dark:text-slate-400 text-xs font-bold uppercase tracking-wider">
                                <tr>
                                    <th class="px-5 py-3">Proceso</th>
                                    <th class="px-5 py-3">Área</th>
                                    <th class="px-5 py-3">Fecha</th>
                                    <th class="px-5 py-3">Monto</th>
                                    <th class="px-5 py-3">Estatus</th>
                                    <th class="px-5 py-3 text-right">Acciones</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100 dark:divide-slate-800" id="tbody-ahorros">
                                <tr>
                                    <td colspan="6" class="px-6 py-10 text-center text-slate-400 text-sm">
                                        <span class="material-symbols-outlined block mb-2 text-slate-300"
                                            style="font-size:44px;">savings</span>
                                        No hay ahorros registrados aún.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div id="pagination-ahorros"
                        class="hidden flex items-center justify-between px-5 py-3 border-t border-slate-100 dark:border-slate-800">
                        <span class="text-xs text-slate-500">
                            Mostrando <span id="pag-start" class="font-bold text-slate-700">0</span>
                            a <span id="pag-end" class="font-bold text-slate-700">0</span>
                            de <span id="pag-total" class="font-bold text-slate-700">0</span> registros
                        </span>
                        <div class="flex items-center gap-2">
                            <button id="btn-prev-page"
                                class="px-3 py-1 rounded-md bg-slate-100 text-slate-600 hover:bg-slate-200 disabled:opacity-50 disabled:cursor-not-allowed transition-colors text-xs font-bold flex items-center gap-1">
                                <span class="material-symbols-outlined" style="font-size:16px;">chevron_left</span> Ant
                            </button>
                            <button id="btn-next-page"
                                class="px-3 py-1 rounded-md bg-slate-100 text-slate-600 hover:bg-slate-200 disabled:opacity-50 disabled:cursor-not-allowed transition-colors text-xs font-bold flex items-center gap-1">
                                Sig <span class="material-symbols-outlined" style="font-size:16px;">chevron_right</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ═══════ CONSOLIDADO ═══════ -->
                <div style="font-size: 113.6%; transform-origin: top left;">
                    <div class="consolidado-section" id="consolidado-section">

                        <div class="flex items-center gap-4 mb-5">
                            <div class="h-px flex-1 bg-gradient-to-r from-transparent via-slate-200 to-transparent">
                            </div>
                            <div
                                class="flex items-center gap-2 px-4 py-1.5 bg-primary/5 border border-primary/10 rounded-full">
                                <span class="material-symbols-outlined text-primary"
                                    style="font-size:19px;">auto_graph</span>
                                <span class="text-xs font-black text-primary tracking-wide uppercase">Consolidado
                                    2025</span>
                            </div>
                            <div class="h-px flex-1 bg-gradient-to-r from-transparent via-slate-200 to-transparent">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-12 gap-5">
                            <div class="lg:col-span-5 flex flex-col gap-4">
                                <!-- Tarjeta Ejecutado -->
                                <div class="stat-card relative overflow-hidden rounded-2xl bg-primary p-5 text-white shadow-xl shadow-primary/20"
                                    style="animation-delay:0.1s">
                                    <div
                                        class="dot-float-1 absolute top-4 right-10 w-20 h-20 bg-white/10 rounded-full blur-xl pointer-events-none">
                                    </div>
                                    <div
                                        class="dot-float-2 absolute bottom-2 right-4 w-12 h-12 bg-accent/20 rounded-full blur-lg pointer-events-none">
                                    </div>
                                    <div class="shimmer-bg absolute inset-0 pointer-events-none"></div>
                                    <div class="relative flex items-start justify-between mb-3">
                                        <div class="flex flex-col">
                                            <span
                                                class="text-[9px] font-black uppercase tracking-[0.15em] text-white/50 mb-0.5">Ahorro
                                                Ejecutado</span>
                                            <span class="text-xs font-semibold text-white/60">Año 2025</span>
                                        </div>
                                        <div class="w-9 h-9 rounded-xl bg-white/10 flex items-center justify-center">
                                            <span class="material-symbols-outlined text-white"
                                                style="font-size:22px;">check_circle</span>
                                        </div>
                                    </div>
                                    <div class="relative">
                                        <div class="text-3xl font-black tracking-tight leading-none">$<span
                                                class="counter" id="counter-ejecutado">0</span></div>
                                        <div class="text-xs text-white/40 font-mono mt-1">COP</div>
                                    </div>
                                </div>

                                <!-- Tarjeta Proyectado -->
                                <div class="stat-card relative overflow-hidden rounded-2xl border-2 border-dashed border-accent/40 bg-white dark:bg-slate-900 p-5 shadow-lg"
                                    style="animation-delay:0.25s">
                                    <div
                                        class="dot-float-3 absolute top-3 right-8 w-16 h-16 bg-accent/10 rounded-full blur-xl pointer-events-none">
                                    </div>
                                    <div class="flex items-start justify-between mb-3">
                                        <div class="flex flex-col">
                                            <span
                                                class="text-[9px] font-black uppercase tracking-[0.15em] text-slate-400 mb-0.5">Proyección
                                                Anual</span>
                                            <span class="text-xs font-semibold text-slate-400">Al cabo de 1 año</span>
                                        </div>
                                        <div class="w-9 h-9 rounded-xl bg-accent/10 flex items-center justify-center"
                                            style="animation: pulseGlow 2s ease infinite;">
                                            <span class="material-symbols-outlined text-accent"
                                                style="font-size:22px;">trending_up</span>
                                        </div>
                                    </div>
                                    <div>
                                        <div
                                            class="text-3xl font-black tracking-tight leading-none text-primary dark:text-white">
                                            $<span class="counter" id="counter-proyectado">0</span></div>
                                        <div class="text-xs text-slate-400 font-mono mt-1">COP</div>
                                    </div>
                                </div>

                                <!-- Barra de progreso -->
                                <div class="stat-card rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 p-5 shadow-sm"
                                    style="animation-delay:0.4s">
                                    <div class="flex items-center justify-between mb-3">
                                        <span
                                            class="text-[9px] font-black uppercase tracking-wider text-slate-500">Avance
                                            hacia la meta</span>
                                        <span id="pct-label" class="text-sm font-black text-accent">0%</span>
                                    </div>
                                    <div id="progress-container"
                                        class="relative h-4 bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden mb-2.5">
                                        <div class="progress-fill h-full rounded-full relative overflow-hidden"
                                            id="main-progress-bar"
                                            style="--target-width: 26.2%; background: linear-gradient(90deg, #102a47 0%, #e51148 100%);">
                                            <div class="shimmer-bg absolute inset-0"></div>
                                        </div>
                                        <div id="progress-marker"
                                            class="absolute top-1/2 -translate-y-1/2 w-3.5 h-3.5 bg-white border-2 border-accent rounded-full shadow-md transition-all duration-[2s] ease-out"
                                            style="left: 0%; opacity:0;"></div>
                                    </div>
                                    <div class="flex justify-between text-[9px] font-bold text-slate-400 font-mono">
                                        <span>$0</span><span id="mid-label">$4.7M</span><span>$9.4M</span>
                                    </div>
                                    <div class="mt-3 space-y-1.5">
                                        <div class="flex items-center gap-2 text-xs">
                                            <div class="w-2.5 h-2.5 rounded-sm bg-primary flex-shrink-0"></div>
                                            <span class="text-slate-500 flex-1">Ejecutado</span>
                                            <span
                                                class="font-bold text-primary dark:text-white font-mono text-[11px]">$2.468.287</span>
                                        </div>
                                        <div class="flex items-center gap-2 text-xs">
                                            <div class="w-2.5 h-2.5 rounded-sm bg-accent flex-shrink-0"></div>
                                            <span class="text-slate-500 flex-1">Faltante proyectado</span>
                                            <span class="font-bold text-accent font-mono text-[11px]">$6.942.269</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- SVG Radial -->
                            <div class="lg:col-span-7">
                                <div
                                    class="rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-sm h-full p-5 flex flex-col">
                                    <div class="flex items-center justify-between mb-4">
                                        <span
                                            class="text-[9px] font-black uppercase tracking-wider text-slate-500">Distribución
                                            por anillos</span>
                                        <div class="flex items-center gap-3 text-[9px] font-bold">
                                            <span class="flex items-center gap-1.5"><span
                                                    class="inline-block w-2.5 h-2.5 rounded-full bg-primary"></span>Ejecutado</span>
                                            <span class="flex items-center gap-1.5"><span
                                                    class="inline-block w-2.5 h-2.5 rounded-full bg-accent"></span>Proyectado</span>
                                            <span class="flex items-center gap-1.5"><span
                                                    class="inline-block w-2.5 h-2.5 rounded-full bg-slate-200"></span>Pendiente</span>
                                        </div>
                                    </div>
                                    <div class="flex-1 flex flex-col items-center justify-center relative"
                                        id="svg-container">
                                        <svg id="radial-svg" viewBox="0 0 360 300" width="100%" height="100%"
                                            style="max-height:330px;">
                                            <defs>
                                                <linearGradient id="grad-ejecutado" x1="0%" y1="0%" x2="100%" y2="0%">
                                                    <stop offset="0%" stop-color="#102a47" />
                                                    <stop offset="100%" stop-color="#1e4d80" />
                                                </linearGradient>
                                                <linearGradient id="grad-proyectado" x1="0%" y1="0%" x2="100%" y2="0%">
                                                    <stop offset="0%" stop-color="#e51148" />
                                                    <stop offset="100%" stop-color="#ff4d80" />
                                                </linearGradient>
                                                <filter id="glow-blue">
                                                    <feGaussianBlur stdDeviation="3" result="coloredBlur" />
                                                    <feMerge>
                                                        <feMergeNode in="coloredBlur" />
                                                        <feMergeNode in="SourceGraphic" />
                                                    </feMerge>
                                                </filter>
                                                <filter id="glow-red">
                                                    <feGaussianBlur stdDeviation="4" result="coloredBlur" />
                                                    <feMerge>
                                                        <feMergeNode in="coloredBlur" />
                                                        <feMergeNode in="SourceGraphic" />
                                                    </feMerge>
                                                </filter>
                                            </defs>
                                            <circle cx="180" cy="155" r="110" fill="none" stroke="#f1f5f9"
                                                stroke-width="16" />
                                            <circle id="arc-proyectado" cx="180" cy="155" r="110" fill="none"
                                                stroke="url(#grad-proyectado)" stroke-width="16" stroke-linecap="round"
                                                transform="rotate(-90 180 155)"
                                                style="--dash-total:691.15;stroke-dasharray:691.15;stroke-dashoffset:691.15;"
                                                class="arc-proyectado" filter="url(#glow-red)" />
                                            <circle cx="180" cy="155" r="78" fill="none" stroke="#f1f5f9"
                                                stroke-width="16" />
                                            <circle id="arc-ejecutado" cx="180" cy="155" r="78" fill="none"
                                                stroke="url(#grad-ejecutado)" stroke-width="16" stroke-linecap="round"
                                                transform="rotate(-90 180 155)"
                                                style="--dash-total:490.09;stroke-dasharray:490.09;stroke-dashoffset:490.09;"
                                                class="arc-ejecutado" filter="url(#glow-blue)" />
                                            <text x="180" y="142" text-anchor="middle" font-family="Outfit,sans-serif"
                                                font-weight="900" font-size="22" fill="#102a47"
                                                id="center-pct">26%</text>
                                            <text x="180" y="162" text-anchor="middle" font-family="Outfit,sans-serif"
                                                font-weight="500" font-size="9" fill="#94a3b8"
                                                letter-spacing="2">EJECUTADO</text>
                                            <text x="180" y="290" text-anchor="middle" font-family="Outfit,sans-serif"
                                                font-weight="700" font-size="9" fill="#e51148"
                                                letter-spacing="1.5">PROYECCIÓN ANUAL · 100%</text>
                                            <circle cx="180" cy="45" r="4" fill="#e51148" opacity="0.6" />
                                            <circle id="exec-endpoint" cx="180" cy="77" r="5" fill="#102a47" />
                                        </svg>
                                        <div id="radial-tooltip"
                                            class="absolute bg-primary text-white text-[10px] font-bold px-3 py-2 rounded-lg shadow-xl pointer-events-none opacity-0 transition-opacity duration-200 whitespace-nowrap z-10"
                                            style="top:16px;right:16px;">
                                            <div id="tooltip-content">—</div>
                                        </div>
                                    </div>
                                    <div class="mt-3 pt-3 border-t border-slate-100 dark:border-slate-800">
                                        <div
                                            class="flex items-center justify-between text-[9px] font-bold uppercase text-slate-400 mb-2 tracking-wider">
                                            <span>Ene 2025</span><span>Hoy</span><span>Dic 2025</span>
                                        </div>
                                        <div
                                            class="relative h-1.5 bg-slate-100 dark:bg-slate-800 rounded-full overflow-visible">
                                            <div class="h-full rounded-full bg-gradient-to-r from-primary/40 to-primary/20"
                                                style="width:16%"></div>
                                            <div class="absolute top-1/2 -translate-y-1/2 -translate-x-1/2 w-3 h-3 bg-primary border-2 border-white rounded-full shadow"
                                                style="left:16%">
                                                <div
                                                    class="absolute -top-6 left-1/2 -translate-x-1/2 bg-primary text-white text-[8px] font-black px-1.5 py-0.5 rounded whitespace-nowrap">
                                                    Feb 2025</div>
                                            </div>
                                            <div class="absolute top-1/2 -translate-y-1/2 -translate-x-1/2 w-3 h-3 bg-accent border-2 border-white rounded-full shadow"
                                                style="left:100%">
                                                <div
                                                    class="absolute -top-6 left-1/2 -translate-x-1/2 bg-accent text-white text-[8px] font-black px-1.5 py-0.5 rounded whitespace-nowrap">
                                                    Meta</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div><!-- /grid consolidado -->

                        <!-- ═══════ ACTIVIDADES ═══════ -->
                        <div id="actividades-section" class="mt-8 act-panel">

                            <div class="flex items-center gap-4 mb-5">
                                <div class="h-px flex-1 bg-gradient-to-r from-transparent via-slate-200 to-transparent">
                                </div>
                                <div
                                    class="flex items-center gap-2 px-4 py-1.5 bg-accent/5 border border-accent/15 rounded-full">
                                    <span class="material-symbols-outlined text-accent"
                                        style="font-size:19px;">stacked_bar_chart</span>
                                    <span
                                        class="text-xs font-black text-primary dark:text-white tracking-wide uppercase">Actividades</span>
                                </div>
                                <div class="h-px flex-1 bg-gradient-to-r from-transparent via-slate-200 to-transparent">
                                </div>
                            </div>

                            <!-- Panel principal -->
                            <div
                                class="rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden">

                                <!-- Header con stats -->
                                <div
                                    class="px-5 pt-4 pb-3.5 bg-gradient-to-r from-primary to-[#1a3f6b] relative overflow-hidden">
                                    <div class="shimmer-bg absolute inset-0 pointer-events-none"></div>
                                    <div class="relative flex flex-wrap items-center justify-between gap-3">
                                        <div>
                                            <div
                                                class="text-[9px] font-black uppercase tracking-widest text-white/50 mb-1.5">
                                                Actividades · Ahorro por proceso</div>
                                            <div class="flex items-center gap-2 flex-wrap">
                                                <span id="act-stat-total" class="stat-pill bg-white/10 text-white">
                                                    <span class="material-symbols-outlined"
                                                        style="font-size:14px;">savings</span>
                                                    <span>Total: —</span>
                                                </span>
                                                <span id="act-stat-count" class="stat-pill bg-white/10 text-white">
                                                    <span class="material-symbols-outlined"
                                                        style="font-size:14px;">format_list_numbered</span>
                                                    <span>0 actividades</span>
                                                </span>
                                                <span id="act-stat-avg" class="stat-pill bg-accent/30 text-white">
                                                    <span class="material-symbols-outlined"
                                                        style="font-size:14px;">avg_pace</span>
                                                    <span>Prom: —</span>
                                                </span>
                                            </div>
                                        </div>
                                        <!-- Búsqueda interna -->
                                        <div class="relative">
                                            <span
                                                class="material-symbols-outlined absolute left-2 top-1/2 -translate-y-1/2 text-slate-400"
                                                style="font-size:15px; line-height:1; pointer-events:none;">search</span>
                                            <input id="act-search" type="text" placeholder="Buscar proceso…"
                                                class="act-search" />
                                        </div>
                                    </div>
                                </div>

                                <div class="glow-sep"></div>

                                <!-- ── Barra de filtros compacta y organizada ── -->
                                <div class="px-5 py-3.5 border-b border-slate-100 dark:border-slate-800 space-y-2.5">

                                    <!-- Fila 1: Mostrar / Ordenar / Modo de visualización -->
                                    <div class="filter-row">
                                        <div class="filter-group">
                                            <span class="filter-label">Ver</span>
                                            <div class="flex gap-1" id="ctrl-limit">
                                                <button class="ctrl-chip active-pri" data-val="10"
                                                    onclick="actSetLimit(this,10)">Top 10</button>
                                                <button class="ctrl-chip inactive" data-val="20"
                                                    onclick="actSetLimit(this,20)">Top 20</button>
                                                <button class="ctrl-chip inactive" data-val="40"
                                                    onclick="actSetLimit(this,40)">Top 40</button>
                                                <button class="ctrl-chip inactive" data-val="999"
                                                    onclick="actSetLimit(this,999)">Todos</button>
                                            </div>
                                        </div>

                                        <div class="filter-divider"></div>

                                        <div class="filter-group">
                                            <span class="filter-label">Ordenar</span>
                                            <select id="ctrl-sort" class="act-select" onchange="actApplyFilters()">
                                                <option value="amount_desc">Mayor ahorro ↓</option>
                                                <option value="amount_asc">Menor ahorro ↑</option>
                                                <option value="date_desc">Más reciente</option>
                                                <option value="date_asc">Más antiguo</option>
                                                <option value="name_asc">Nombre A→Z</option>
                                                <option value="reduction_desc">Mayor % reducción</option>
                                            </select>
                                        </div>

                                        <div class="filter-divider"></div>

                                        <div class="filter-group">
                                            <span class="filter-label">Métrica</span>
                                            <div class="flex gap-1" id="ctrl-mode">
                                                <button class="ctrl-chip active-pri" data-val="amount"
                                                    onclick="actSetMode(this,'amount')">Ahorro</button>
                                                <button class="ctrl-chip inactive" data-val="reduction"
                                                    onclick="actSetMode(this,'reduction')">% Reducción</button>
                                                <button class="ctrl-chip inactive" data-val="before"
                                                    onclick="actSetMode(this,'before')">Costo Antes</button>
                                                <button class="ctrl-chip inactive" data-val="after"
                                                    onclick="actSetMode(this,'after')">Costo Actual</button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Fila 2: Estatus / Área / Fecha / Monto mín -->
                                    <div class="filter-row">
                                        <div class="filter-group">
                                            <span class="filter-label">Estatus</span>
                                            <div class="flex gap-1" id="ctrl-status">
                                                <button class="ctrl-chip active-pri" data-val="all"
                                                    onclick="actSetStatus(this,'all')">Todos</button>
                                                <button class="ctrl-chip inactive" data-val="Realizado"
                                                    onclick="actSetStatus(this,'Realizado')">Realizado</button>
                                                <button class="ctrl-chip inactive" data-val="Proyectado"
                                                    onclick="actSetStatus(this,'Proyectado')">Proyectado</button>
                                                <button class="ctrl-chip inactive" data-val="Pendiente"
                                                    onclick="actSetStatus(this,'Pendiente')">Pendiente</button>
                                            </div>
                                        </div>

                                        <div class="filter-divider"></div>

                                        <div class="filter-group">
                                            <span class="filter-label">Área</span>
                                            <select id="ctrl-area" class="act-select" onchange="actApplyFilters()">
                                                <option value="all">Todas</option>
                                            </select>
                                        </div>

                                        <div class="filter-divider"></div>

                                        <div class="filter-group">
                                            <span class="filter-label">Fecha</span>
                                            <input type="date" id="ctrl-date-from" class="act-date"
                                                onchange="actApplyFilters()" />
                                            <span class="text-slate-300 font-bold text-xs">–</span>
                                            <input type="date" id="ctrl-date-to" class="act-date"
                                                onchange="actApplyFilters()" />
                                            <button onclick="actClearDates()" class="ctrl-chip inactive"
                                                style="padding:3px 7px;">
                                                <span class="material-symbols-outlined"
                                                    style="font-size:14px;">close</span>
                                            </button>
                                        </div>

                                        <div class="filter-divider"></div>

                                        <div class="filter-group">
                                            <span class="filter-label">Mín.</span>
                                            <select id="ctrl-min" class="act-select" onchange="actApplyFilters()">
                                                <option value="0">Sin mín.</option>
                                                <option value="100000">$100 K</option>
                                                <option value="500000">$500 K</option>
                                                <option value="1000000">$1 M</option>
                                                <option value="5000000">$5 M</option>
                                            </select>
                                        </div>

                                        <button onclick="actResetFilters()" class="ctrl-chip inactive ml-auto"
                                            style="gap:3px;">
                                            <span class="material-symbols-outlined"
                                                style="font-size:14px;">restart_alt</span>
                                            Resetear
                                        </button>
                                    </div>

                                    <!-- Tags de filtros activos -->
                                    <div id="active-filters-strip"
                                        class="hidden flex flex-wrap gap-1.5 pt-2 border-t border-slate-100"></div>
                                </div>

                                <!-- ── Eje de referencia ── -->
                                <div class="px-5 pt-3.5 pb-1">
                                    <div class="flex items-center"
                                        style="padding-bottom:5px;border-bottom:1px solid #f1f5f9;">
                                        <div
                                            class="chart-label text-[9px] font-black uppercase tracking-wider text-slate-400 text-right pr-3">
                                            Proceso</div>
                                        <div class="flex-1 flex items-center justify-between px-2">
                                            <span class="text-[8.5px] font-bold text-slate-300 font-mono">$0</span>
                                            <span id="axis-mid"
                                                class="text-[8.5px] font-bold text-slate-300 font-mono">—</span>
                                            <span id="axis-max"
                                                class="text-[8.5px] font-bold text-slate-300 font-mono">—</span>
                                        </div>
                                        <div
                                            class="chart-meta text-[9px] font-black uppercase tracking-wider text-slate-400">
                                            Detalle</div>
                                    </div>
                                </div>

                                <!-- Chart -->
                                <div class="chart-scroll px-5 pb-5" id="act-chart-container">
                                    <div class="empty-chart">
                                        <span class="material-symbols-outlined text-slate-300"
                                            style="font-size:53px;">bar_chart</span>
                                        <span class="text-sm font-bold text-slate-400">Cargando actividades…</span>
                                    </div>
                                </div>

                            </div>
                        </div>
                        <!-- FIN ACTIVIDADES -->

                    </div><!-- /consolidado-section -->
                </div><!-- /scale-wrapper -->

            </div><!-- /p-6 -->
        </main>
    </div>

    <!-- Tooltip flotante -->
    <div id="act-tooltip" class="act-tooltip"></div>

    <!-- ── Modal: Registrar Ahorro ── -->
    <div id="modal-ahorro" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/40">
        <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl w-full max-w-lg p-7 relative">
            <button id="modal-close"
                class="absolute top-4 right-4 text-slate-400 hover:text-slate-700 transition-colors">
                <span class="material-symbols-outlined" style="font-size:27px;">close</span>
            </button>
            <h3 class="text-lg font-black text-primary dark:text-white mb-5 flex items-center gap-2">
                <span class="material-symbols-outlined" style="font-size:25px;">savings</span>Registrar Ahorro
            </h3>
            <form id="form-ahorro" class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs font-semibold text-slate-700 dark:text-slate-300 block mb-1">Proceso
                            Asociado</label>
                        <select name="project_id" id="ahorro-project-select" required
                            class="w-full px-3 py-2 border border-slate-200 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800 text-sm focus:ring-2 focus:ring-primary/20 focus:outline-none">
                            <option value="" disabled selected>Cargando procesos...</option>
                        </select>
                    </div>
                    <div>
                        <label
                            class="text-xs font-semibold text-slate-700 dark:text-slate-300 block mb-1">Encargado</label>
                        <input id="ahorro-encargado" type="text" readonly placeholder="Auto-completado"
                            class="w-full px-3 py-2 border border-slate-200 dark:border-slate-700 rounded-lg bg-slate-200 dark:bg-slate-700 text-sm cursor-not-allowed opacity-70" />
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs font-semibold text-slate-700 dark:text-slate-300 block mb-1">Costo Mensual
                            SYP (COP)</label>
                        <input id="costo_mensual_display" type="text" required placeholder="0"
                            class="w-full px-3 py-2 border border-slate-200 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-800 text-sm focus:ring-2 focus:ring-primary/20 focus:outline-none" />
                        <input type="hidden" name="costo_mensual" id="costo_mensual_value" value="0">
                    </div>
                    <div>
                        <label class="text-xs font-semibold text-slate-700 dark:text-slate-300 block mb-1">Costo por
                            Hora (COP)</label>
                        <input id="costo_hora_display" type="text" readonly placeholder="Calculado"
                            class="w-full px-3 py-2 border border-slate-200 dark:border-slate-700 rounded-lg bg-slate-200 dark:bg-slate-700 text-sm font-bold text-primary cursor-not-allowed opacity-70" />
                        <input type="hidden" name="costo_hora" id="costo_hora_value" value="0">
                    </div>
                </div>
                <div class="space-y-3 pt-3 border-t border-slate-200">
                    <h4 class="text-sm font-bold text-primary flex items-center gap-1.5">
                        <span class="material-symbols-outlined" style="font-size:19px;">history</span> ANTES
                    </h4>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase block mb-1">Tiempo por
                                Empleado</label>
                            <input name="tiempo_empleado_antes" id="tiempo_empleado_antes" type="number" step="any"
                                min="0" required
                                class="w-full px-3 py-2 border border-slate-200 rounded-lg bg-slate-50 text-sm focus:ring-2 focus:ring-primary/20 focus:outline-none" />
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase block mb-1">Tiempo de
                                Gestión</label>
                            <div class="flex">
                                <input name="tiempo_gestion_antes" id="tiempo_gestion_antes" type="number" step="any"
                                    min="0" required
                                    class="w-full px-3 py-2 border border-slate-200 rounded-l-lg bg-slate-50 text-sm focus:ring-2 focus:ring-primary/20 focus:outline-none" />
                                <select name="tiempo_gestion_antes_tipo" id="tiempo_gestion_antes_tipo"
                                    class="px-2 py-2 border-y border-r border-slate-200 rounded-r-lg bg-slate-100 text-xs focus:outline-none">
                                    <option value="Mensual">Mensual</option>
                                    <option value="Anual">Anual</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 uppercase block mb-1">Total ANTES</label>
                        <input id="total_antes_display" type="text" readonly placeholder="Calculado"
                            class="w-full px-3 py-2 border border-slate-200 rounded-lg bg-slate-200 text-sm font-bold text-red-600 cursor-not-allowed opacity-70" />
                        <input type="hidden" name="total_antes" id="total_antes_value" value="0">
                    </div>
                </div>
                <div class="space-y-3 pt-3 border-t border-slate-200">
                    <h4 class="text-sm font-bold text-primary flex items-center gap-1.5">
                        <span class="material-symbols-outlined" style="font-size:19px;">update</span> ACTUAL
                    </h4>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase block mb-1">Tiempo por
                                Empleado</label>
                            <input name="tiempo_empleado_actual" id="tiempo_empleado_actual" type="number" step="any"
                                min="0" required
                                class="w-full px-3 py-2 border border-slate-200 rounded-lg bg-slate-50 text-sm focus:ring-2 focus:ring-primary/20 focus:outline-none" />
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase block mb-1">Tiempo de
                                Gestión</label>
                            <div class="flex">
                                <input name="tiempo_gestion_actual" id="tiempo_gestion_actual" type="number" step="any"
                                    min="0" required
                                    class="w-full px-3 py-2 border border-slate-200 rounded-l-lg bg-slate-50 text-sm focus:ring-2 focus:ring-primary/20 focus:outline-none" />
                                <select name="tiempo_gestion_actual_tipo" id="tiempo_gestion_actual_tipo"
                                    class="px-2 py-2 border-y border-r border-slate-200 rounded-r-lg bg-slate-100 text-xs focus:outline-none">
                                    <option value="Mensual">Mensual</option>
                                    <option value="Anual">Anual</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 uppercase block mb-1">Total ACTUAL</label>
                        <input id="total_actual_display" type="text" readonly placeholder="Calculado"
                            class="w-full px-3 py-2 border border-slate-200 rounded-lg bg-slate-200 text-sm font-bold text-emerald-600 cursor-not-allowed opacity-70" />
                        <input type="hidden" name="total_actual" id="total_actual_value" value="0">
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-3 pt-4 border-t border-slate-200 items-end">
                    <div>
                        <label class="text-xs font-semibold text-slate-700 block mb-1">Fecha</label>
                        <input name="date" type="date" required
                            class="w-full px-3 py-2 border border-slate-200 rounded-lg bg-slate-50 text-sm focus:ring-2 focus:ring-primary/20 focus:outline-none" />
                    </div>
                    <div>
                        <label class="text-xs font-semibold text-slate-700 block mb-1">Estatus</label>
                        <select name="status"
                            class="w-full px-3 py-2 border border-slate-200 rounded-lg bg-slate-50 text-sm focus:ring-2 focus:ring-primary/20 focus:outline-none">
                            <option>Proyectado</option>
                            <option>Pendiente</option>
                            <option>Realizado</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-primary block mb-1">Ahorro</label>
                        <input id="ahorro_total_display" type="text" readonly placeholder="Calculado"
                            class="w-full px-3 py-2 border border-accent rounded-lg bg-accent/10 text-sm font-black text-accent cursor-not-allowed focus:outline-none" />
                        <input type="hidden" name="amount" id="ahorro_total_value" value="0">
                    </div>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" id="modal-cancel"
                        class="px-4 py-2 text-sm font-bold text-slate-600 hover:bg-slate-100 rounded-lg transition-colors">Cancelar</button>
                    <button type="submit"
                        class="px-7 py-2 bg-accent text-white font-bold rounded-lg hover:bg-accent/90 transition-all shadow-lg shadow-accent/20">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ── Modal: Gráfica ── -->
    <div id="modal-chart" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/40">
        <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl w-full max-w-4xl p-7 relative">
            <button id="modal-chart-close"
                class="absolute top-4 right-4 text-slate-400 hover:text-slate-700 transition-colors">
                <span class="material-symbols-outlined" style="font-size:27px;">close</span>
            </button>
            <h3 class="text-lg font-black text-primary dark:text-white mb-5 flex items-center gap-2">
                <span class="material-symbols-outlined" style="font-size:25px;">bar_chart</span>
                Comparativa de Costos: <span id="chart-process-name" class="text-primary font-bold ml-1"></span>
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-7">
                <div class="flex flex-col items-center">
                    <h4 class="text-xs font-bold text-slate-500 mb-2">Costos vs Ahorro</h4>
                    <div class="relative w-full h-60"><canvas id="ahorrosChart"></canvas></div>
                </div>
                <div class="flex flex-col items-center">
                    <h4 class="text-xs font-bold text-slate-500 mb-2">Proporción (Actual vs Ahorro)</h4>
                    <div class="relative w-full h-60"><canvas id="ahorrosPieChart"></canvas></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ═══════════ JAVASCRIPT ═══════════ -->
    <script>
        const API = 'https://proyectossyp.onrender.com/api';
        const fmt = n => new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 }).format(n);
        const fmtShort = n => {
            if (n >= 1_000_000) return '$' + (n / 1_000_000).toFixed(1).replace('.', ',') + ' M';
            if (n >= 1_000) return '$' + (n / 1_000).toFixed(0) + ' K';
            return '$' + n;
        };
        const fmtPct = n => n.toFixed(1) + '%';

        const statusColor = {
            'Realizado': 'bg-emerald-100 text-emerald-800',
            'Pendiente': 'bg-amber-100 text-amber-800',
            'Proyectado': 'bg-blue-100 text-blue-800',
        };

        const EJECUTADO = 2468287;
        const PROYECTADO = 9410556;
        const PCT_AVANCE = (EJECUTADO / PROYECTADO * 100).toFixed(1);

        let allAhorros = [], allProcesosList = [], filteredAhorros = [];
        let currentPage = 1;
        const ITEMS_PER_PAGE = 10;
        let chartInstance = null, pieChartInstance = null;

        /* ══ TABLA ══ */
        function renderAhorros(data, resetPage = true) {
            filteredAhorros = data;
            if (resetPage) currentPage = 1;
            const total = filteredAhorros.length;
            const startIdx = (currentPage - 1) * ITEMS_PER_PAGE;
            const endIdx = Math.min(startIdx + ITEMS_PER_PAGE, total);
            const paginated = filteredAhorros.slice(startIdx, endIdx);
            const tbody = document.getElementById('tbody-ahorros');
            if (!paginated.length) {
                tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-10 text-center text-slate-400 text-sm">
                    <span class="material-symbols-outlined block mb-2 text-slate-300" style="font-size:44px;">savings</span>
                    No hay ahorros registrados aún.</td></tr>`;
                updatePaginationUI(0, 0, 0); return;
            }
            tbody.innerHTML = paginated.map(s => {
                const sc = statusColor[s.status] || 'bg-slate-100 text-slate-600';
                return `<tr class="hover:bg-primary/5 transition-colors cursor-pointer group">
                    <td class="px-5 py-4"><div class="flex flex-col">
                        <span class="font-bold text-primary dark:text-white text-sm">${s.project_name || ('Proceso #' + s.project_id)}</span>
                        <span class="text-xs text-slate-400">ID: ${s.project_id}</span>
                    </div></td>
                    <td class="px-5 py-4 text-sm font-medium">${s.project_area || '—'}</td>
                    <td class="px-5 py-4 text-sm text-slate-500">${s.date || '—'}</td>
                    <td class="px-5 py-4 text-sm font-bold text-primary dark:text-white">${fmt(s.amount)}</td>
                    <td class="px-5 py-4"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold ${sc}">${s.status}</span></td>
                    <td class="px-5 py-4 text-right"><div class="flex items-center justify-end opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick='openChartModal(${JSON.stringify(s).replace(/'/g, "&#39;")})' title="Visualizar"
                            class="p-1.5 hover:bg-blue-50 rounded-lg text-slate-400 hover:text-blue-500 transition-colors">
                            <span class="material-symbols-outlined" style="font-size:22px;">bar_chart</span>
                        </button>
                        <button onclick="deleteAhorro(${s.id})" title="Eliminar"
                            class="p-1.5 hover:bg-red-50 rounded-lg text-slate-400 hover:text-red-500 transition-colors">
                            <span class="material-symbols-outlined" style="font-size:22px;">delete</span>
                        </button>
                    </div></td>
                </tr>`;
            }).join('');
            updatePaginationUI(startIdx + 1, endIdx, total);
        }

        function updatePaginationUI(start, end, total) {
            const c = document.getElementById('pagination-ahorros');
            if (total === 0) { c.classList.add('hidden'); return; }
            c.classList.remove('hidden');
            document.getElementById('pag-start').textContent = start;
            document.getElementById('pag-end').textContent = end;
            document.getElementById('pag-total').textContent = total;
            document.getElementById('btn-prev-page').disabled = currentPage === 1;
            document.getElementById('btn-next-page').disabled = currentPage * ITEMS_PER_PAGE >= total;
        }
        document.getElementById('btn-prev-page').onclick = () => { if (currentPage > 1) { currentPage--; renderAhorros(filteredAhorros, false); } };
        document.getElementById('btn-next-page').onclick = () => { if (currentPage * ITEMS_PER_PAGE < filteredAhorros.length) { currentPage++; renderAhorros(filteredAhorros, false); } };

        async function loadAhorros() {
            try {
                const data = await fetch(`${API}/ahorros`).then(r => r.json());
                allAhorros = Array.isArray(data) ? data : [];
                renderAhorros(allAhorros);
            } catch (e) { console.warn('Backend no disponible.'); }
        }
        async function deleteAhorro(id) {
            if (!confirm('¿Eliminar este registro de ahorro?')) return;
            await fetch(`${API}/ahorros/${id}`, { method: 'DELETE' });
            loadAhorros();
        }

        /* ══ SELECT PROCESOS ══ */
        async function loadProcesosForSelect() {
            try {
                const procesos = await fetch(`${API}/proyectos`).then(r => r.json());
                allProcesosList = procesos;
                const select = document.getElementById('ahorro-project-select');
                const fin = procesos.filter(p => p.status === 'Finalizado');
                if (!fin.length) { select.innerHTML = '<option value="" disabled selected>No hay procesos finalizados</option>'; return; }
                select.innerHTML = '<option value="" disabled selected>Selecciona un proceso...</option>' +
                    fin.map(p => `<option value="${p.id}">#${p.id} - ${p.name}</option>`).join('');
            } catch (e) { console.warn('Error cargando procesos.'); }
        }

        /* ══ BUSCADOR TABLA ══ */
        document.getElementById('search-ahorros').addEventListener('input', function () {
            const q = this.value.toLowerCase();
            renderAhorros(allAhorros.filter(s =>
                (s.project_name || '').toLowerCase().includes(q) ||
                (s.project_area || '').toLowerCase().includes(q) ||
                (s.status || '').toLowerCase().includes(q)
            ));
        });

        /* ══ MODAL AHORRO ══ */
        const modal = document.getElementById('modal-ahorro');
        document.getElementById('btn-nuevo-ahorro').onclick = () => modal.classList.remove('hidden');
        document.getElementById('modal-close').onclick = () => modal.classList.add('hidden');
        document.getElementById('modal-cancel').onclick = () => modal.classList.add('hidden');

        document.getElementById('form-ahorro').onsubmit = async (e) => {
            e.preventDefault();
            const fd = new FormData(e.target), body = Object.fromEntries(fd.entries());
            body.project_id = parseInt(body.project_id); body.amount = parseFloat(body.amount) || 0;
            body.costo_mensual = parseFloat(body.costo_mensual) || 0; body.costo_hora = parseFloat(body.costo_hora) || 0;
            body.tiempo_empleado_antes = parseFloat(body.tiempo_empleado_antes) || 0;
            body.tiempo_empleado_actual = parseFloat(body.tiempo_empleado_actual) || 0;
            body.tiempo_gestion_antes = parseFloat(body.tiempo_gestion_antes) || 0;
            body.tiempo_gestion_actual = parseFloat(body.tiempo_gestion_actual) || 0;
            body.total_antes = parseFloat(body.total_antes) || 0; body.total_actual = parseFloat(body.total_actual) || 0;
            await fetch(`${API}/ahorros`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
            modal.classList.add('hidden'); e.target.reset();
            ['costo_mensual_display', 'ahorro-encargado', 'total_antes_display', 'total_actual_display', 'costo_hora_display', 'ahorro_total_display']
                .forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
            loadAhorros();
        };

        function formatNoDecimals(n) { return new Intl.NumberFormat('es-CO', { maximumFractionDigits: 0 }).format(n); }
        function calculateAhorros() {
            const raw = document.getElementById('costo_mensual_display').value.replace(/\./g, '').replace(/,/g, '');
            const costoMensual = parseFloat(raw) || 0;
            document.getElementById('costo_mensual_value').value = costoMensual;
            if (raw && !isNaN(costoMensual)) document.getElementById('costo_mensual_display').value = costoMensual ? formatNoDecimals(costoMensual) : '';
            const costoHora = costoMensual / 180;
            document.getElementById('costo_hora_value').value = costoHora;
            document.getElementById('costo_hora_display').value = fmt(costoHora);
            const tgA = parseFloat(document.getElementById('tiempo_gestion_antes').value) || 0;
            const mA = document.getElementById('tiempo_gestion_antes_tipo').value === 'Mensual' ? 12 : 1;
            const tA = tgA * costoHora * mA;
            document.getElementById('total_antes_value').value = tA; document.getElementById('total_antes_display').value = fmt(tA);
            const tgC = parseFloat(document.getElementById('tiempo_gestion_actual').value) || 0;
            const mC = document.getElementById('tiempo_gestion_actual_tipo').value === 'Mensual' ? 12 : 1;
            const tC = tgC * costoHora * mC;
            document.getElementById('total_actual_value').value = tC; document.getElementById('total_actual_display').value = fmt(tC);
            const ahorro = tA - tC;
            document.getElementById('ahorro_total_value').value = ahorro; document.getElementById('ahorro_total_display').value = fmt(ahorro);
        }
        ['costo_mensual_display', 'tiempo_gestion_antes', 'tiempo_gestion_actual', 'tiempo_gestion_antes_tipo', 'tiempo_gestion_actual_tipo']
            .forEach(id => { const el = document.getElementById(id); if (el) { el.addEventListener('input', calculateAhorros); el.addEventListener('change', calculateAhorros); } });
        document.getElementById('ahorro-project-select').addEventListener('change', function () {
            const p = allProcesosList.find(x => x.id === parseInt(this.value));
            document.getElementById('ahorro-encargado').value = p ? (p.encargado || '') : '';
        });

        /* ══ MODAL CHART ══ */
        const modalChart = document.getElementById('modal-chart');
        document.getElementById('modal-chart-close').onclick = () => modalChart.classList.add('hidden');

        function openChartModal(saving) {
            document.getElementById('chart-process-name').textContent = saving.project_name || ('Proceso #' + saving.project_id);
            modalChart.classList.remove('hidden');
            const ctxBar = document.getElementById('ahorrosChart').getContext('2d');
            const ctxPie = document.getElementById('ahorrosPieChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            if (pieChartInstance) pieChartInstance.destroy();
            const tt = { callbacks: { label: ctx => { let l = ctx.dataset.label || ctx.label || ''; if (l) l += ': '; return l + fmt(ctx.parsed.y !== undefined ? ctx.parsed.y : ctx.parsed); } } };
            chartInstance = new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: ['ANTES', 'ACTUAL', 'AHORRO'],
                    datasets: [{
                        label: 'COP ($)', data: [saving.total_antes, saving.total_actual, saving.amount],
                        backgroundColor: ['rgba(16,42,71,0.9)', 'rgba(30,77,128,0.9)', 'rgba(229,17,72,0.9)'], borderRadius: 5
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: tt }, scales: { y: { beginAtZero: true, ticks: { callback: v => fmtShort(v) } } } }
            });
            pieChartInstance = new Chart(ctxPie, {
                type: 'doughnut',
                data: {
                    labels: ['Total Actual', 'Ahorro Logrado'],
                    datasets: [{
                        data: [saving.total_actual, saving.amount],
                        backgroundColor: ['rgba(16,42,71,0.9)', 'rgba(229,17,72,0.9)'], hoverOffset: 4, borderWidth: 2
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, cutout: '60%', plugins: { tooltip: tt, legend: { position: 'bottom' } } }
            });
        }

        /* ══ CONSOLIDADO – Animaciones ══ */
        function animateCounter(el, from, to, dur, formatter) {
            const t0 = performance.now();
            function step(now) {
                const p = Math.min((now - t0) / dur, 1), e = 1 - Math.pow(1 - p, 3);
                el.textContent = formatter(Math.round(from + (to - from) * e));
                if (p < 1) requestAnimationFrame(step);
            }
            requestAnimationFrame(step);
        }
        function formatCOP(n) { return new Intl.NumberFormat('es-CO', { maximumFractionDigits: 0 }).format(n); }

        let consolidadoAnimated = false;
        function triggerConsolidadoAnimation() {
            if (consolidadoAnimated) return; consolidadoAnimated = true;
            document.getElementById('consolidado-section').classList.add('visible');
            document.querySelectorAll('.stat-card').forEach((c, i) => { c.style.animationDelay = `${.1 + i * .15}s`; c.style.animationFillMode = 'forwards'; });
            setTimeout(() => { animateCounter(document.getElementById('counter-ejecutado'), 0, EJECUTADO, 2000, formatCOP); animateCounter(document.getElementById('counter-proyectado'), 0, PROYECTADO, 2500, formatCOP); }, 200);
            setTimeout(() => { const el = document.getElementById('pct-label'); let c = 0, t = parseFloat(PCT_AVANCE); const iv = setInterval(() => { c += .5; if (c >= t) { c = t; clearInterval(iv); } el.textContent = c.toFixed(1) + '%'; }, 30); }, 400);
            setTimeout(() => { document.getElementById('main-progress-bar').parentElement.classList.add('progress-animated'); const m = document.getElementById('progress-marker'); m.style.left = PCT_AVANCE + '%'; m.style.opacity = '1'; }, 500);
            setTimeout(() => {
                document.getElementById('arc-proyectado').style.strokeDashoffset = '0';
                const pct = EJECUTADO / PROYECTADO, circ = 490.09;
                document.getElementById('arc-ejecutado').style.strokeDashoffset = String(circ * (1 - pct));
                const cp = document.getElementById('center-pct'); let c = 0; const iv = setInterval(() => { c += .5; if (c >= parseFloat(PCT_AVANCE)) { c = parseFloat(PCT_AVANCE); clearInterval(iv); } cp.textContent = Math.round(c) + '%'; }, 40);
                const ang = (-90 + pct * 360) * (Math.PI / 180), r = 78, cx = 180, cy = 155;
                setTimeout(() => { const ep = document.getElementById('exec-endpoint'); ep.setAttribute('cx', (cx + r * Math.cos(ang)).toFixed(1)); ep.setAttribute('cy', (cy + r * Math.sin(ang)).toFixed(1)); }, 1800);
            }, 700);
        }

        document.getElementById('arc-ejecutado').addEventListener('mouseenter', () => { const t = document.getElementById('radial-tooltip'); document.getElementById('tooltip-content').innerHTML = `<div>Ejecutado 2025</div><div class="text-blue-200 mt-0.5">${fmt(EJECUTADO)} · ${PCT_AVANCE}%</div>`; t.style.opacity = '1'; });
        document.getElementById('arc-ejecutado').addEventListener('mouseleave', () => { document.getElementById('radial-tooltip').style.opacity = '0'; });
        document.getElementById('arc-proyectado').addEventListener('mouseenter', () => { const t = document.getElementById('radial-tooltip'); document.getElementById('tooltip-content').innerHTML = `<div>Proyección Anual</div><div class="text-red-200 mt-0.5">${fmt(PROYECTADO)} · 100%</div>`; t.style.opacity = '1'; });
        document.getElementById('arc-proyectado').addEventListener('mouseleave', () => { document.getElementById('radial-tooltip').style.opacity = '0'; });

        const observer = new IntersectionObserver(entries => { if (entries[0].isIntersecting) { triggerConsolidadoAnimation(); observer.disconnect(); } }, { threshold: .2 });
        observer.observe(document.getElementById('consolidado-section'));

        /* ══════════════════════════════════════════════════════
           ACTIVIDADES – motor de filtrado + gráfica custom
        ══════════════════════════════════════════════════════ */
        (function () {
            // ── Brand colors for bars (azul y rojo del sistema) ──
            const STATUS_GRAD = {
                'Realizado': 'linear-gradient(90deg,#102a47 0%,#1e4d80 100%)',   // azul primario
                'Proyectado': 'linear-gradient(90deg,#e51148 0%,#c20e3e 100%)',   // rojo accent
                'Pendiente': 'linear-gradient(90deg,#1a3f6b 0%,#e51148 100%)',   // azul→rojo
            };
            const STATUS_DOT = {
                'Realizado': '#102a47',
                'Proyectado': '#e51148',
                'Pendiente': '#94a3b8',
            };

            // Reduction-based: use system palette shades
            const REDUCTION_GRAD = {
                high: 'linear-gradient(90deg,#102a47 0%,#1e4d80 100%)',   // >75% → deep blue
                mid: 'linear-gradient(90deg,#1a3f6b 0%,#e51148 100%)',   // 40-75% → blue→red
                low: 'linear-gradient(90deg,#e51148 0%,#c20e3e 100%)',   // <40% → red
            };

            let state = { limit: 10, sort: 'amount_desc', status: 'all', mode: 'amount', dateFrom: '', dateTo: '', area: 'all', minAmount: 0, search: '' };
            let actData = [], actLoaded = false;

            const tooltip = document.getElementById('act-tooltip');
            function showTooltip(e, html) { tooltip.innerHTML = html; tooltip.style.opacity = '1'; moveTooltip(e); }
            function moveTooltip(e) { tooltip.style.left = (e.clientX + 14) + 'px'; tooltip.style.top = (e.clientY - 10) + 'px'; }
            function hideTooltip() { tooltip.style.opacity = '0'; }

            function barGrad(item) {
                if (state.mode === 'reduction') {
                    const pct = item._reduction;
                    if (pct >= 75) return REDUCTION_GRAD.high;
                    if (pct >= 40) return REDUCTION_GRAD.mid;
                    return REDUCTION_GRAD.low;
                }
                return STATUS_GRAD[item.status] || STATUS_GRAD['Proyectado'];
            }

            function enrich(arr) {
                return arr.map(a => ({ ...a, _reduction: a.total_antes ? ((a.total_antes - a.total_actual) / a.total_antes * 100) : 0 }));
            }

            function actApplyFilters() {
                state.sort = document.getElementById('ctrl-sort').value;
                state.dateFrom = document.getElementById('ctrl-date-from').value;
                state.dateTo = document.getElementById('ctrl-date-to').value;
                state.area = document.getElementById('ctrl-area').value;
                state.minAmount = parseFloat(document.getElementById('ctrl-min').value) || 0;
                state.search = document.getElementById('act-search').value.toLowerCase();
                renderActChart();
                renderActiveFiltersStrip();
            }

            function actSetLimit(btn, val) {
                document.querySelectorAll('#ctrl-limit .ctrl-chip').forEach(b => b.className = 'ctrl-chip inactive');
                btn.className = 'ctrl-chip active-pri';
                state.limit = val; actApplyFilters();
            }
            function actSetStatus(btn, val) {
                document.querySelectorAll('#ctrl-status .ctrl-chip').forEach(b => b.className = 'ctrl-chip inactive');
                const cls = val === 'all' ? 'active-pri' : val === 'Realizado' ? 'active-pri' : val === 'Proyectado' ? 'active-mid' : 'active-amb';
                btn.className = 'ctrl-chip ' + cls;
                state.status = val; actApplyFilters();
            }
            function actSetMode(btn, val) {
                document.querySelectorAll('#ctrl-mode .ctrl-chip').forEach(b => b.className = 'ctrl-chip inactive');
                btn.className = 'ctrl-chip active-pri';
                state.mode = val; actApplyFilters();
            }
            function actClearDates() {
                document.getElementById('ctrl-date-from').value = '';
                document.getElementById('ctrl-date-to').value = '';
                actApplyFilters();
            }
            function actResetFilters() {
                state = { limit: 10, sort: 'amount_desc', status: 'all', mode: 'amount', dateFrom: '', dateTo: '', area: 'all', minAmount: 0, search: '' };
                document.getElementById('ctrl-sort').value = 'amount_desc';
                document.getElementById('ctrl-date-from').value = '';
                document.getElementById('ctrl-date-to').value = '';
                document.getElementById('ctrl-area').value = 'all';
                document.getElementById('ctrl-min').value = '0';
                document.getElementById('act-search').value = '';
                document.querySelectorAll('#ctrl-limit .ctrl-chip').forEach(b => { b.className = 'ctrl-chip inactive'; if (b.dataset.val === '10') b.className = 'ctrl-chip active-pri'; });
                document.querySelectorAll('#ctrl-status .ctrl-chip').forEach(b => { b.className = 'ctrl-chip inactive'; if (b.dataset.val === 'all') b.className = 'ctrl-chip active-pri'; });
                document.querySelectorAll('#ctrl-mode .ctrl-chip').forEach(b => { b.className = 'ctrl-chip inactive'; if (b.dataset.val === 'amount') b.className = 'ctrl-chip active-pri'; });
                renderActChart(); renderActiveFiltersStrip();
            }

            function renderActiveFiltersStrip() {
                const strip = document.getElementById('active-filters-strip');
                const tags = [];
                if (state.status !== 'all') tags.push({ label: 'Estatus: ' + state.status, clear: () => { document.querySelectorAll('#ctrl-status .ctrl-chip').forEach(b => { b.className = 'ctrl-chip inactive'; if (b.dataset.val === 'all') b.className = 'ctrl-chip active-pri'; }); state.status = 'all'; actApplyFilters(); } });
                if (state.dateFrom) tags.push({ label: 'Desde: ' + state.dateFrom, clear: () => { document.getElementById('ctrl-date-from').value = ''; actApplyFilters(); } });
                if (state.dateTo) tags.push({ label: 'Hasta: ' + state.dateTo, clear: () => { document.getElementById('ctrl-date-to').value = ''; actApplyFilters(); } });
                if (state.area !== 'all') tags.push({ label: 'Área: ' + state.area, clear: () => { document.getElementById('ctrl-area').value = 'all'; state.area = 'all'; actApplyFilters(); } });
                if (state.minAmount > 0) tags.push({ label: 'Mín: ' + fmtShort(state.minAmount), clear: () => { document.getElementById('ctrl-min').value = '0'; state.minAmount = 0; actApplyFilters(); } });
                if (state.search) tags.push({ label: 'Buscar: ' + state.search, clear: () => { document.getElementById('act-search').value = ''; state.search = ''; actApplyFilters(); } });
                if (!tags.length) { strip.classList.add('hidden'); return; }
                strip.classList.remove('hidden');
                strip.innerHTML = '<span class="filter-label self-center">Filtros activos:</span>' +
                    tags.map((t, i) => `<span class="active-filter-tag">${t.label}<button onclick="__actClearTag(${i})">×</button></span>`).join('');
                window.__actTagClearFns = tags.map(t => t.clear);
            }
            window.__actClearTag = i => window.__actTagClearFns[i]();

            function populateAreaSelect() {
                const areas = [...new Set(actData.map(a => a.project_area || '').filter(Boolean))].sort();
                const sel = document.getElementById('ctrl-area');
                sel.innerHTML = '<option value="all">Todas</option>' + areas.map(a => `<option value="${a}">${a}</option>`).join('');
            }

            function getFiltered() {
                let arr = enrich([...actData]);
                if (state.status !== 'all') arr = arr.filter(a => a.status === state.status);
                if (state.dateFrom) arr = arr.filter(a => a.date >= state.dateFrom);
                if (state.dateTo) arr = arr.filter(a => a.date <= state.dateTo);
                if (state.area !== 'all') arr = arr.filter(a => (a.project_area || '') === state.area);
                if (state.minAmount > 0) arr = arr.filter(a => a.amount >= state.minAmount);
                if (state.search) arr = arr.filter(a => (a.project_name || '').toLowerCase().includes(state.search) || (a.project_area || '').toLowerCase().includes(state.search));
                const [field, dir] = state.sort.split('_');
                arr.sort((a, b) => {
                    let va, vb;
                    if (field === 'amount') { va = a.amount; vb = b.amount; }
                    else if (field === 'date') { va = a.date || ''; vb = b.date || ''; }
                    else if (field === 'name') { va = a.project_name || ''; vb = b.project_name || ''; }
                    else if (field === 'reduction') { va = a._reduction; vb = b._reduction; }
                    else { va = a.amount; vb = b.amount; }
                    if (dir === 'asc') return va > vb ? 1 : va < vb ? -1 : 0;
                    return va < vb ? 1 : va > vb ? -1 : 0;
                });
                const limit = state.limit === 999 ? arr.length : state.limit;
                return arr.slice(0, limit);
            }

            function updateHeaderStats(arr) {
                const total = arr.reduce((s, a) => s + a.amount, 0);
                const avg = arr.length ? total / arr.length : 0;
                document.getElementById('act-stat-total').querySelector('span:last-child').textContent = 'Total: ' + fmtShort(total);
                document.getElementById('act-stat-count').querySelector('span:last-child').textContent = arr.length + ' actividades';
                document.getElementById('act-stat-avg').querySelector('span:last-child').textContent = 'Prom: ' + fmtShort(avg);
            }

            function renderActChart() {
                const arr = getFiltered();
                const container = document.getElementById('act-chart-container');
                updateHeaderStats(arr);
                if (!arr.length) {
                    container.innerHTML = `<div class="empty-chart">
                        <span class="material-symbols-outlined text-slate-300" style="font-size:53px;">search_off</span>
                        <span class="text-sm font-bold text-slate-400">Sin resultados con los filtros actuales</span>
                        <button onclick="actResetFilters()" class="text-xs font-black text-accent underline mt-1">Limpiar filtros</button>
                    </div>`;
                    document.getElementById('axis-mid').textContent = '—';
                    document.getElementById('axis-max').textContent = '—';
                    return;
                }
                const getValue = a => {
                    if (state.mode === 'amount') return a.amount;
                    if (state.mode === 'reduction') return a._reduction;
                    if (state.mode === 'before') return a.total_antes || 0;
                    if (state.mode === 'after') return a.total_actual || 0;
                    return a.amount;
                };
                const maxVal = Math.max(...arr.map(getValue), 1);
                const isPercent = state.mode === 'reduction';
                const axisFmt = v => isPercent ? fmtPct(v) : fmtShort(v);
                document.getElementById('axis-mid').textContent = axisFmt(maxVal / 2);
                document.getElementById('axis-max').textContent = axisFmt(maxVal);

                const rows = arr.map((item, i) => {
                    const val = getValue(item);
                    const pct = Math.max((val / maxVal) * 100, 0.5).toFixed(2);
                    const grad = barGrad(item);
                    const label = item.project_name.length > 26 ? item.project_name.slice(0, 24) + '…' : item.project_name;
                    const valFmt = isPercent ? fmtPct(val) : fmtShort(val);
                    const dotCol = STATUS_DOT[item.status] || '#94a3b8';
                    const delay = (i * 0.04).toFixed(3);
                    let sub1 = '', sub2 = '';
                    if (state.mode === 'amount') { sub1 = item.date || '—'; sub2 = item.status; }
                    if (state.mode === 'reduction') { sub1 = fmtShort(item.total_antes || 0) + ' → ' + fmtShort(item.total_actual || 0); sub2 = item.status; }
                    if (state.mode === 'before') { sub1 = 'Actual: ' + fmtShort(item.total_actual || 0); sub2 = item.date || '—'; }
                    if (state.mode === 'after') { sub1 = 'Ahorro: ' + fmtShort(item.amount); sub2 = item.date || '—'; }
                    const ttData = JSON.stringify({
                        name: item.project_name, area: item.project_area || '—',
                        amount: fmt(item.amount), before: fmt(item.total_antes || 0),
                        after: fmt(item.total_actual || 0), reduction: fmtPct(item._reduction),
                        status: item.status, date: item.date || '—'
                    }).replace(/"/g, '&quot;');
                    return `
                    <div class="chart-row" style="animation:actFadeUp .4s cubic-bezier(.16,1,.3,1) ${delay}s both;"
                        data-tt="${ttData}" onmouseenter="__actShowTT(event,this)" onmousemove="__actMoveTT(event)" onmouseleave="__actHideTT()">
                        <div class="chart-label" title="${item.project_name}">
                            <span style="display:inline-block;width:6px;height:6px;border-radius:50%;background:${dotCol};margin-right:4px;vertical-align:middle;flex-shrink:0;"></span>${label}
                        </div>
                        <div class="chart-track">
                            <div class="chart-grid" style="left:25%"></div>
                            <div class="chart-grid" style="left:50%"></div>
                            <div class="chart-grid" style="left:75%"></div>
                            <div class="chart-bar" style="width:${pct}%;background:${grad};animation-delay:${delay}s;">
                                <div class="chart-bar-shimmer"></div>
                                <span class="chart-val" style="animation-delay:${(parseFloat(delay) + .55).toFixed(2)}s;">${valFmt}</span>
                            </div>
                        </div>
                        <div class="chart-meta">
                            <span style="font-size:9.5px;font-weight:700;color:#334155;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${sub1}</span>
                            <span style="font-size:11px;color:#94a3b8;">${sub2}</span>
                        </div>
                    </div>`;
                }).join('');
                container.innerHTML = `<div style="display:flex;flex-direction:column;gap:3px;padding-top:6px;">${rows}</div>`;
            }

            window.__actShowTT = (e, el) => {
                const d = JSON.parse(el.dataset.tt.replace(/&quot;/g, '"'));
                showTooltip(e, `
                    <div style="font-size:13px;font-weight:900;margin-bottom:5px;border-bottom:1px solid rgba(255,255,255,.1);padding-bottom:4px;">${d.name}</div>
                    <div style="display:grid;grid-template-columns:auto 1fr;gap:2px 9px;font-size:9.5px;">
                        <span style="opacity:.5">Área</span><span>${d.area}</span>
                        <span style="opacity:.5">Ahorro</span><span style="color:#ff6b94;font-weight:900;">${d.amount}</span>
                        <span style="opacity:.5">Antes</span><span>${d.before}</span>
                        <span style="opacity:.5">Actual</span><span>${d.after}</span>
                        <span style="opacity:.5">Reducción</span><span style="color:#7dd3fc;">${d.reduction}</span>
                        <span style="opacity:.5">Estatus</span><span>${d.status}</span>
                        <span style="opacity:.5">Fecha</span><span>${d.date}</span>
                    </div>`);
            };
            window.__actMoveTT = e => moveTooltip(e);
            window.__actHideTT = () => hideTooltip();

            window.actSetLimit = actSetLimit;
            window.actSetStatus = actSetStatus;
            window.actSetMode = actSetMode;
            window.actClearDates = actClearDates;
            window.actResetFilters = actResetFilters;
            window.actApplyFilters = actApplyFilters;

            async function loadActivities() {
                try {
                    const [ahorros, proyectos] = await Promise.all([
                        fetch(`${API}/ahorros`).then(r => r.json()),
                        fetch(`${API}/proyectos`).then(r => r.json()),
                    ]);
                    const map = {};
                    (proyectos || []).forEach(p => { map[p.id] = p; });
                    actData = (ahorros || []).map(a => ({
                        ...a,
                        project_name: map[a.project_id]?.name || `Proceso #${a.project_id}`,
                        project_area: map[a.project_id]?.area || '',
                    }));
                    populateAreaSelect();
                    renderActChart();
                    renderActiveFiltersStrip();
                } catch (e) {
                    console.warn('Error cargando actividades', e);
                    document.getElementById('act-chart-container').innerHTML =
                        `<div class="empty-chart"><span class="material-symbols-outlined text-slate-300" style="font-size:53px;">cloud_off</span><span class="text-sm font-bold text-slate-400">No se pudo conectar al servidor</span></div>`;
                }
            }

            document.getElementById('act-search').addEventListener('input', function () {
                state.search = this.value.toLowerCase(); renderActChart(); renderActiveFiltersStrip();
            });

            const actObs = new IntersectionObserver(entries => {
                if (entries[0].isIntersecting && !actLoaded) { actLoaded = true; loadActivities(); actObs.disconnect(); }
            }, { threshold: .1 });
            actObs.observe(document.getElementById('actividades-section'));

        }()); /* fin IIFE actividades */

        /* ══ INIT ══ */
        loadAhorros();
        loadProcesosForSelect();
    </script>
</body>

</html>